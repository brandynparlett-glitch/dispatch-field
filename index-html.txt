<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Minute Medic Dispatch Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #101827;
      color: #e5e7eb;
    }

    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }

    .app {
      width: min(1200px, 100%);
      padding: 1.5rem;
      box-sizing: border-box;
    }

    .card {
      background: #111827;
      border-radius: 0.75rem;
      padding: 1.25rem;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
      border: 1px solid #1f2933;
    }

    h1 {
      margin: 0 0 0.75rem 0;
      font-size: 1.6rem;
    }

    .subtitle {
      font-size: 0.95rem;
      color: #9ca3af;
      margin-bottom: 1.2rem;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 0.75rem;
    }

    label {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #9ca3af;
      display: block;
      margin-bottom: 0.25rem;
    }

    input, select, textarea {
      width: 100%;
      box-sizing: border-box;
      background: #020617;
      border: 1px solid #1f2937;
      border-radius: 0.5rem;
      padding: 0.45rem 0.6rem;
      color: #e5e7eb;
      font-size: 0.85rem;
    }

    textarea {
      resize: vertical;
      min-height: 40px;
    }

    input:focus, select:focus, textarea:focus {
      outline: 2px solid #3b82f6;
      outline-offset: 1px;
      border-color: #3b82f6;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.9rem;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 0.45rem 0.9rem;
      font-size: 0.85rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      white-space: nowrap;
    }

    .btn-primary {
      background: #3b82f6;
      color: white;
    }

    .btn-secondary {
      background: #111827;
      color: #e5e7eb;
      border: 1px solid #374151;
    }

    .btn-danger {
      background: #7f1d1d;
      color: #fee2e2;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: default;
    }

    .table-wrapper {
      margin-top: 1.25rem;
      border-radius: 0.75rem;
      border: 1px solid #1f2937;
      overflow: auto;
      max-height: 60vh;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
      min-width: 800px;
    }

    thead {
      background: #020617;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    th, td {
      padding: 0.4rem 0.6rem;
      text-align: left;
      border-bottom: 1px solid #1f2937;
      vertical-align: top;
    }

    th {
      font-weight: 600;
      color: #9ca3af;
      white-space: nowrap;
    }

    tr:nth-child(even) td {
      background: #020617;
    }

    .pill {
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      font-size: 0.7rem;
      display: inline-block;
    }

    .pill-priority-High {
      background: #7f1d1d;
      color: #fee2e2;
    }

    .pill-priority-Medium {
      background: #78350f;
      color: #ffedd5;
    }

    .pill-priority-Low {
      background: #064e3b;
      color: #d1fae5;
    }

    .pill-status-Pending {
      background: #1f2937;
      color: #e5e7eb;
    }

    .pill-status-En\ route {
      background: #1d4ed8;
      color: #dbeafe;
    }

    .pill-status-On\ scene {
      background: #7c2d12;
      color: #ffedd5;
    }

    .pill-status-Complete {
      background: #064e3b;
      color: #d1fae5;
    }

    .tiny {
      font-size: 0.7rem;
      color: #6b7280;
      margin-top: 0.25rem;
    }

    @media (max-width: 640px) {
      .card {
        padding: 0.9rem;
        border-radius: 0;
      }

      h1 {
        font-size: 1.3rem;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <h1>Minute Medic Dispatch</h1>
      <div class="subtitle">
        Simple field dispatch board for medics &amp; drivers. Add a call, assign crew, update status.
      </div>

      <!-- FORM -->
      <form id="dispatchForm">
        <div class="grid">
          <div>
            <label for="callId">Call ID / Ticket #</label>
            <input id="callId" name="callId" placeholder="e.g. BB-2025-001" required />
          </div>
          <div>
            <label for="client">Client / Company</label>
            <input id="client" name="client" placeholder="e.g. TC Energy" />
          </div>
          <div>
            <label for="location">Location / LSD</label>
            <input id="location" name="location" placeholder="e.g. 04-21-065-05W6" />
          </div>
          <div>
            <label for="priority">Priority</label>
            <select id="priority" name="priority">
              <option>Low</option>
              <option selected>Medium</option>
              <option>High</option>
            </select>
          </div>
          <div>
            <label for="medic">Medic</label>
            <input id="medic" name="medic" placeholder="e.g. Brandy" />
          </div>
          <div>
            <label for="driver">Driver</label>
            <input id="driver" name="driver" placeholder="e.g. John" />
          </div>
          <div>
            <label for="status">Status</label>
            <select id="status" name="status">
              <option selected>Pending</option>
              <option>En route</option>
              <option>On scene</option>
              <option>Complete</option>
            </select>
          </div>
          <div>
            <label for="eta">ETA / Start Time</label>
            <input id="eta" name="eta" placeholder="e.g. 07:30" />
          </div>
        </div>

        <div style="margin-top:0.75rem;">
          <label for="notes">Notes</label>
          <textarea id="notes" name="notes" placeholder="Gate codes, hazards, radio channel, etc."></textarea>
        </div>

        <div class="btn-row">
          <button type="submit" class="btn btn-primary">
            ➕ Add Call
          </button>
          <button type="button" id="clearFormBtn" class="btn btn-secondary">
            ✖ Clear Form
          </button>
          <button type="button" id="exportBtn" class="btn btn-secondary">
            ⬇ Export CSV
          </button>
        </div>
      </form>

      <!-- TABLE -->
      <div class="table-wrapper" style="margin-top:1.25rem;">
        <table id="callsTable">
          <thead>
            <tr>
              <th>Call ID</th>
              <th>Client / Location</th>
              <th>Medic / Driver</th>
              <th>Priority</th>
              <th>Status</th>
              <th>ETA</th>
              <th>Notes</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <!-- rows go here -->
          </tbody>
        </table>
      </div>
      <div class="tiny">
        Tip: this is all front-end only. No login. No database. Perfect for GitHub Pages.
      </div>
    </div>
  </div>

  <script>
    const form = document.getElementById("dispatchForm");
    const clearFormBtn = document.getElementById("clearFormBtn");
    const exportBtn = document.getElementById("exportBtn");
    const tableBody = document.querySelector("#callsTable tbody");

    /** In-memory list of calls */
    const calls = [];

    form.addEventListener("submit", (e) => {
      e.preventDefault();

      const call = {
        callId: document.getElementById("callId").value.trim(),
        client: document.getElementById("client").value.trim(),
        location: document.getElementById("location").value.trim(),
        priority: document.getElementById("priority").value,
        medic: document.getElementById("medic").value.trim(),
        driver: document.getElementById("driver").value.trim(),
        status: document.getElementById("status").value,
        eta: document.getElementById("eta").value.trim(),
        notes: document.getElementById("notes").value.trim(),
        createdAt: new Date().toLocaleString(),
      };

      if (!call.callId) {
        alert("Call ID is required.");
        return;
      }

      // Prevent duplicate Call IDs
      if (calls.some((c) => c.callId === call.callId)) {
        alert("That Call ID already exists on the board.");
        return;
      }

      calls.push(call);
      renderTable();
      form.reset();
      document.getElementById("priority").value = "Medium";
      document.getElementById("status").value = "Pending";
    });

    clearFormBtn.addEventListener("click", () => {
      form.reset();
      document.getElementById("priority").value = "Medium";
      document.getElementById("status").value = "Pending";
    });

    exportBtn.addEventListener("click", () => {
      if (!calls.length) {
        alert("No calls to export yet.");
        return;
      }
      const csv = callsToCSV(calls);
      downloadCSV(csv, "minute-medic-dispatch.csv");
    });

    function renderTable() {
      tableBody.innerHTML = "";

      calls.forEach((call, index) => {
        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td>
            <strong>${escapeHTML(call.callId)}</strong>
            <div class="tiny">${escapeHTML(call.createdAt)}</div>
          </td>
          <td>
            <div>${escapeHTML(call.client || "-")}</div>
            <div class="tiny">${escapeHTML(call.location || "")}</div>
          </td>
          <td>
            <div>Medic: ${escapeHTML(call.medic || "-")}</div>
            <div class="tiny">Driver: ${escapeHTML(call.driver || "-")}</div>
          </td>
          <td>
            <span class="pill pill-priority-${call.priority}">
              ${escapeHTML(call.priority)}
            </span>
          </td>
          <td>
            <select data-index="${index}" class="statusSelect">
              ${["Pending", "En route", "On scene", "Complete"]
                .map(
                  (status) =>
                    `<option ${
                      status === call.status ? "selected" : ""
                    }>${status}</option>`
                )
                .join("")}
            </select>
          </td>
          <td>${escapeHTML(call.eta || "-")}</td>
          <td style="max-width:220px;">
            ${escapeHTML(call.notes || "")}
          </td>
          <td>
            <button type="button" class="btn btn-danger btn-small" data-delete="${index}">
              ✖
            </button>
          </td>
        `;

        tableBody.appendChild(tr);
      });

      // Wire up status dropdowns
      document.querySelectorAll(".statusSelect").forEach((sel) => {
        sel.addEventListener("change", (e) => {
          const idx = Number(e.target.dataset.index);
          calls[idx].status = e.target.value;
          renderTable(); // re-render to update pill style
        });
      });

      // Wire up delete buttons
      document.querySelectorAll("[data-delete]").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          const idx = Number(e.target.dataset.delete);
          calls.splice(idx, 1);
          renderTable();
        });
      });
    }

    function callsToCSV(list) {
      const header = [
        "Call ID",
        "Client",
        "Location",
        "Priority",
        "Medic",
        "Driver",
        "Status",
        "ETA",
        "Notes",
        "Created At",
      ];

      const rows = list.map((c) => [
        c.callId,
        c.client,
        c.location,
        c.priority,
        c.medic,
        c.driver,
        c.status,
        c.eta,
        c.notes,
        c.createdAt,
      ]);

      return [header, ...rows]
        .map((row) =>
          row
            .map((value) => {
              const v = value == null ? "" : String(value);
              return `"${v.replace(/"/g, '""')}"`;
            })
            .join(",")
        )
        .join("\n");
    }

    function downloadCSV(csv, filename) {
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    function escapeHTML(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }
  </script>
</body>
</html>
